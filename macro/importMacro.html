<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理模型命名空间 (带别名) - 可交互原型</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --font-color: #212529;
            --border-color: #dee2e6;
            --background-color: #fff;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 0.3rem;
            --box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
        }
        body {
            font-family: var(--font-family);
            background-color: #f0f2f5;
            color: var(--font-color);
            padding: 40px;
        }
        .button {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.5rem 1rem; font-size: 1rem; font-weight: 400;
            border-radius: var(--border-radius); border: 1px solid transparent;
            cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .button-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .button-primary:hover { background-color: var(--primary-hover); }
        .button-secondary { background-color: var(--background-color); color: var(--font-color); border-color: var(--border-color); }
        .button-secondary:hover { background-color: var(--light-gray); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }

        .modal-container {
            background-color: var(--background-color); border-radius: var(--border-radius);
            box-shadow: var(--box-shadow); width: 90%; max-width: 600px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 1.25rem; font-weight: 500; margin: 0; }
        .modal-body { padding: 16px; min-height: 400px; max-height: 70vh; overflow-y: auto; }
        .modal-footer {
            padding: 16px 24px; border-top: 1px solid var(--border-color);
            display: flex; justify-content: flex-end;
        }
        
        .search-bar { width: 100%; padding: 0.5rem; margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1rem; }
        
        .list-section-title {
            font-size: 0.9rem; font-weight: 600; color: #6c757d;
            padding: 8px 0; margin: 16px 0 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .list-section-title:first-child { margin-top: 0; }
        
        .item-list { list-style: none; padding: 0; margin: 0; }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 8px; border-bottom: 1px solid var(--light-gray);
        }
        
        .item-content { flex-grow: 1; }
        .item-info strong { font-weight: 500; }
        .item-info .alias-display { color: #007bff; font-size: 0.9em; font-family: monospace; }
        .item-info small { color: #888; display: block; }
        
        .item-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .action-button { font-size: 0.9rem; padding: 0.3rem 0.8rem; }
        .icon-button { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; display: flex; align-items: center;}
        .icon-button:hover { background-color: var(--medium-gray); }
        
        /* Edit Mode Styles */
        .edit-form { display: flex; flex-direction: column; gap: 6px; }
        .edit-form-input { padding: 4px 6px; font-size: 0.9em; border: 1px solid var(--primary-color); border-radius: var(--border-radius); }
        .edit-form-actions { display: flex; gap: 6px; }
        .edit-form-actions button { padding: 2px 8px; font-size: 0.8em; }
    </style>
</head>
<body>

    <button class="button button-primary" onclick="NamespaceManager.open()">管理模型命名空间</button>

    <div id="manager-modal" class="modal-overlay">
        <div class="modal-container">
            <header class="modal-header">
                <h3 class="modal-title">管理模型命名空间</h3>
            </header>
            <main class="modal-body">
                <input type="search" id="search-input" class="search-bar" placeholder="搜索命名空间...">
                <div id="list-container"></div>
            </main>
            <footer class="modal-footer">
                <button class="button button-primary" onclick="NamespaceManager.close()">完成</button>
            </footer>
        </div>
    </div>
    
    <div id="confirmation-overlay" class="modal-overlay" style="background-color: rgba(0,0,0,0.3);">
        <!-- Simplified inline confirmation for this prototype -->
    </div>

    <script>
    const NamespaceManager = (() => {
        // --- 模拟数据 ---
        let db = {
            allNamespaces: [
                { id: 1, name: 'default', alias: 'default', macro_count: 3, inProject: true, canRemove: false },
                { id: 2, name: 'materials_properties', alias: null, macro_count: 15, inProject: false, canRemove: true },
                { id: 3, name: 'geometry_utils', alias: 'geo', macro_count: 8, inProject: true, canRemove: true },
                { id: 4, name: 'project_specific', alias: 'proj', macro_count: 2, inProject: true, canRemove: true },
                { id: 101, name: 'shared_calculations', alias: null, macro_count: 5, inProject: false, canRemove: true },
                { id: 102, name: 'vendor_materials', alias: null, macro_count: 12, inProject: false, canRemove: true },
                { id: 103, name: 'fasteners_library_long_name', alias: null, macro_count: 32, inProject: false, canRemove: true },
            ]
        };

        // --- 状态管理 ---
        let state = {
            editingItemId: null,
            searchTerm: ''
        };

        const DOM = {
            modal: document.getElementById('manager-modal'),
            listContainer: document.getElementById('list-container'),
            searchInput: document.getElementById('search-input'),
        };

        // --- 渲染函数 ---
        const render = () => {
            const projectItems = db.allNamespaces.filter(ns => ns.inProject && ns.name.toLowerCase().includes(state.searchTerm));
            const availableItems = db.allNamespaces.filter(ns => !ns.inProject && ns.name.toLowerCase().includes(state.searchTerm));
            
            DOM.listContainer.innerHTML = `
                ${renderSection('当前模型中的命名空间', projectItems)}
                ${renderSection('可从共享库添加', availableItems)}
            `;
        };
        
        const renderSection = (title, items) => {
             if (items.length === 0 && state.searchTerm !== '') return '';
             let itemsHtml = items.map(ns => {
                if (state.editingItemId === ns.id) {
                    return renderEditItem(ns);
                } else {
                    return renderDisplayItem(ns);
                }
             }).join('');

             if (items.length === 0) {
                itemsHtml = '<li class="list-item" style="color:#999; justify-content:center;">无可用项</li>';
             }

             return `<div class="list-section-title">${title}</div><ul class="item-list">${itemsHtml}</ul>`;
        };

        const renderDisplayItem = (ns) => `
            <li class="list-item">
                <div class="item-content">
                    <div class="item-info">
                        <strong>${ns.name}</strong>
                        ${ns.inProject && ns.alias ? `<span class="alias-display">as: ${ns.alias}</span>` : ''}
                        <small>${ns.macro_count}个宏</small>
                    </div>
                </div>
                <div class="item-actions">
                    ${ns.inProject ? `
                        <button class="icon-button edit-btn" data-id="${ns.id}" title="编辑别名">✎</button>
                        <button class="button action-button remove-btn" data-id="${ns.id}" ${!ns.canRemove ? 'disabled title="默认命名空间不可移除"' : ''}>移除</button>
                    ` : `
                        <button class="button action-button add-btn" data-id="${ns.id}">添加</button>
                    `}
                </div>
            </li>
        `;

        const renderEditItem = (ns) => `
            <li class="list-item" style="background-color: #f0f8ff;">
                <div class="item-content">
                    <div class="item-info"><strong>${ns.name}</strong></div>
                    <form class="edit-form" data-id="${ns.id}">
                        <label for="alias-input-${ns.id}" style="font-size: 0.8em; color: #555;">设置别名:</label>
                        <input type="text" id="alias-input-${ns.id}" class="edit-form-input" value="${ns.alias || ns.name}">
                        <div class="edit-form-actions">
                            <button type="submit" class="button button-primary" style="padding: 2px 8px; font-size: 0.8em;">保存</button>
                            <button type="button" class="button button-secondary cancel-edit-btn" data-id="${ns.id}" style="padding: 2px 8px; font-size: 0.8em;">取消</button>
                        </div>
                    </form>
                </div>
            </li>
        `;

        // --- 事件处理 ---
        const handleListClick = (event) => {
            const target = event.target;
            const id = parseInt(target.closest('[data-id]')?.dataset.id);
            if (!id) return;

            const ns = db.allNamespaces.find(n => n.id === id);

            if (target.matches('.add-btn')) {
                ns.inProject = true;
                ns.alias = ns.name; // Default alias
                state.editingItemId = ns.id; // Enter edit mode immediately
            } else if (target.matches('.remove-btn')) {
                // Simplified confirmation for prototype
                if (confirm(`确定要从模型中移除 "${ns.name}" 吗？`)) {
                    ns.inProject = false;
                    ns.alias = null;
                }
            } else if (target.matches('.edit-btn')) {
                state.editingItemId = ns.id;
            } else if (target.matches('.cancel-edit-btn')) {
                state.editingItemId = null;
            }
            render();
            if (state.editingItemId === ns.id) {
                document.getElementById(`alias-input-${ns.id}`).focus();
            }
        };

        const handleFormSubmit = (event) => {
             event.preventDefault();
             const form = event.target;
             const id = parseInt(form.dataset.id);
             const ns = db.allNamespaces.find(n => n.id === id);
             const input = form.querySelector('input');
             
             // Basic validation
             if (input.value.trim() === '') {
                 alert('别名不能为空');
                 return;
             }
             
             ns.alias = input.value.trim();
             state.editingItemId = null;
             render();
        };

        // --- 公开方法 ---
        const open = () => {
            state.searchTerm = '';
            state.editingItemId = null;
            DOM.searchInput.value = '';
            render();
            DOM.modal.classList.add('visible');
        };

        const close = () => {
            DOM.modal.classList.remove('visible');
        };
        
        // --- 初始化 ---
        const init = () => {
            DOM.listContainer.addEventListener('click', handleListClick);
            DOM.listContainer.addEventListener('submit', handleFormSubmit);
            DOM.searchInput.addEventListener('input', (e) => {
                state.searchTerm = e.target.value.toLowerCase();
                render();
            });
        };

        return { open, close, init };
    })();

    document.addEventListener('DOMContentLoaded', NamespaceManager.init);
    </script>

</body>
</html>